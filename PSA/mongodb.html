<!DOCTYPE html>
<html>
  <head>
    <title>PSA</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="core/fonts/mono.css"> 
    <link rel="stylesheet" type="text/css" href="core/css/animate.css"> 
    <link rel="stylesheet" type="text/css" href="core/css/cinescript.css"> 
    <link rel="stylesheet" type="text/css" href="core/css/style_core.css"> 
    <link rel="stylesheet" type="text/css" href="core/css/mermaid.css"> 
    <link rel="stylesheet" type="text/css" href="core/css/gitgraph.css"> 
    <link rel="stylesheet" type="text/css" href="core/css/style_ensiie.css"> 
  </head>
  <body>
    <textarea id="source" readonly>

layout: true
class: animated fadeIn middle numbers

.footnote[
`PSA` - N. Dubray - ENSIIE - 2018 - [:book:](../index.html)
]

---

# MongoDB

.hcenter.w40[![](images/mongodb_logo.svg)]

## History
* **10gen software** started the development in **2007**
* Open source development model in **2009** (paid support and services)
* **10gen software** renamed to **MongoDB inc.** in **2013**
* October 2017, publicly-traded company (`MDB`)

## In an nutshell
* is a **NoSQL** database program (document database)
* can use schemas **or not**
* is **scalable** and **replicable** (with load-balancing)
* can execute javascript **server-side** (e.g. `mapreduce`)
* can do **transactions** (02/2018)
* one of the main databases for **Big Data**

.block[
* Repository: [https://github.com/mongodb/mongo](https://github.com/mongodb/mongo)
* Website: [https://www.mongodb.com](https://www.mongodb.com)
* License: `AGPLv3` + `Apache`
]

---

# MongoDB - Characteristics

## Built-in capabilities

:+: Queries: field, range, regexp, javaScript (server-side)...  
:+: Indexing: **optional**, primary and secondary keys  
:+: Replication: **automatic election** of a new master in case of failure  
:+: Load balancing: **sharding** uses a **shard key** to distribute data over `MongoDB` instances  
:+: File storage: `MongoDB` can act as a **load-balanced**, **replicated** file system (`GridFS`)  
:+: Aggregation: allows to perform e.g. `mapreduce` operations  
:+: Capped collections: some collections can be capped and become **circular queues** when filled  
:+: Transactions: **almost there !** (`ACID` planned for `v4.0`)

---

# MongoDB - Scalability

:arrow_right: How to increase the performances of a given `DBMS` ?

.row[
.column.w65[
## Vertical scaling
:arrow_right: **Add resources to existing servers**  
:+: nothing to change in the servers config  
:warning: may cause some indisponibility  
:warning: is limited by the hardware  
]
.column.w30[
.mermaid[
  graph TD
  A(Master) --> B(Slave 0)
  A(Master) --> C(Slave 1)
  A(Master) --> D(Slave 2)
  style A fill:#2A2
  style B fill:#2A2
  style C fill:#2A2
  style D fill:#2A2
]
]
]

.row[
.column.w55[
## Horizontal scaling
:arrow_right: **Add more servers**  
:+: nothing to change in the servers config  
:+: can be transparent  
:+: is not limited by the hardware  
]
.column.w40[
.mermaid[
  graph TD
  A(Master) --> B(Slave 0)
  A(Master) --> C(Slave 1)
  A(Master) --> D(Slave 2)
  A(Master) -.-> E(Slave 3)
  style E fill:#2A2
]
]
]


## Horizontal scaling with `SQL`-type `DBMS`
:warning: is often done **manualy**  
:warning: **may break transactions integrity**

## Horizontal scaling with `MongoDB` (**sharding**)
:+: is a built-in mechanism  
:+: is almost transparent to the admin  
:+: can use different hardware  

---

# MongoDB - Schemas ?

## `SQL`-type `DBMS`
:warning: a schema has to be defined **before inserting data**  
:warning: **new data has to follow the existing schema**  
:warning: to change the schema, existing data must be **migrated**

.vspace[]

## `MongoDB`
:+: schemas can be used **or not**  
:+: if no schema is used, new data can have **any attributes**  
:+: a schema can be created, changed or removed at any time, **no migration needed**  
:arrow_right: a schema can be used for **updating** or **inserting** data

---

# MongoDB - Overview

## Data hierarchy
.mermaid[
  graph LR
  A(MongoDB instance) --> B
  B(Database) --> C
  C(Collection) --> D
  D(Document) --> E(Field)
]

## Example
.tree.hcenter[
`MongoDB` instance
* Database: `privateBase`
   * Collection: `MusicRecords`
      * Document:
         * Field `"_id"`: `10A5F24771`
         * Field `"band"`: `"Pink Floyd"`
         * Field `"song"`: `"Wish You Were Here"`
      * Document:
         * Field `"_id"`: `10A5F264EC`
         * Field `"band"`: `"Pink Floyd"`
         * Field `"song"`: `"Have a Cigar"`
         * Field `"year"`: `1975`
* Database: `proBase`

]

---

# MongoDB - Installation

## Ubuntu 17.10

```shell
*$ apt update
Hit:1 http://fr.archive.ubuntu.com/ubuntu artful InRelease
Hit:2 http://fr.archive.ubuntu.com/ubuntu artful-updates InRelease      
Hit:3 http://security.ubuntu.com/ubuntu artful-security InRelease       
Hit:4 http://fr.archive.ubuntu.com/ubuntu artful-backports InRelease
Reading package lists... Done                     
Building dependency tree       
Reading state information... Done
All packages are up to date.
*$ apt install mongodb-server
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following additional packages will be installed:
  libboost-chrono1.62.0 mongo-tools mongodb-clients
The following NEW packages will be installed:
  libboost-chrono1.62.0 mongo-tools mongodb-clients mongodb-server
0 upgraded, 4 newly installed, 0 to remove and 3 not upgraded.
Need to get 47.8 MB of archives.
After this operation, 207 MB of additional disk space will be used.
Do you want to continue? [Y/n] 
Get:1 http://fr.archive.ubuntu.com/ubuntu artful/main amd64 libboost-chrono1.62.0 amd64 1.62.0+dfsg-4build3 [11.8 kB]
Get:2 http://fr.archive.ubuntu.com/ubuntu artful/universe amd64 mongo-tools amd64 3.2.11-1 [9,993 kB]
Get:3 http://fr.archive.ubuntu.com/ubuntu artful/universe amd64 mongodb-clients amd64 1:3.4.7-1 [18.7 MB]
Get:4 http://fr.archive.ubuntu.com/ubuntu artful/universe amd64 mongodb-server amd64 1:3.4.7-1 [19.2 MB]
Fetched 47.8 MB in 20s (2,293 kB/s)                                                           
[...]
Setting up libboost-chrono1.62.0:amd64 (1.62.0+dfsg-4build3) ...
Setting up mongo-tools (3.2.11-1) ...
Setting up mongodb-clients (1:3.4.7-1) ...
Setting up mongodb-server (1:3.4.7-1) ...
Processing triggers for libc-bin (2.26-0ubuntu2.1) ...
```

---

# MongoDB - Configuration file

.row[
.column.w48[
:arrow_right: **Old format**

## .hcenter[\[/etc/mongodb.conf\]]
```ini
# mongodb.conf

# Where to store the data.
*dbpath=/home/mongodb

#where to log
*logpath=/home/mongodb/mongodb.log

logappend=true

bind_ip = 127.0.0.1
#port = 27017

# Enable journaling, http://www.mongodb.org/display/DOCS/Journaling
*journal=false

# Enables periodic logging of CPU utilization and I/O wait
#cpu = true

# Turn on/off security.  Off is currently the default
#noauth = true
#auth = true

[...]
```
]

.column.w48[
:arrow_right: **New format**

## .hcenter[\[/etc/mongodb.conf\]]
```ini
storage:
* dbpath: "/home/mongodb"
  journal:
*   enabled: false
systemLog:
  destination: file
* path: "/home/mongodb/mongodb.log"
  logappend: true
net:
  bindIp: 127.0.0.1
  port: 27017
* maxIncomingConnections: 20000
security:
  authorization: disabled
```
]
]

---

# MongoDB - Start a server

## With `Systemd`

```shell
$ systemctl start mongodb.service
$ systemctl status mongodb.service
TODO
$ journalctl -u mongodb
TODO
```

---

# MongoDB - Users

## Database user
:arrow_right: Several users can be defined **for each database**  
:warning: Different users with the same name can exist for different databases  
:arrow_right: A user will have to be identified **for a given database**

.vspace[]

## User's roles
:arrow_right: User permitted actions are defined in **`roles`**  
:warning: Some roles can allow modifications **to other databases**  
:arrow_right: Several **built-in roles** exist, but **custom roles** can be constructed

.vspace[]

## Privileges
:arrow_right: A role is a set of **privileges**  
:arrow_right: Example of privileges for the `read` built-in role in database `test_db`:  
* `collStats`, `dbHash`, `dbStats`, `find`, `killCursors`, `listCollections`, `listIndexes`, `planCacheRead` for `test_db.*` collections.

---

# MongoDB - Built-in roles

.row[
.column.w48[
## Database User Roles
* `read`
* `readWrite`

## Database Administration Roles
* `dbAdmin`
* `dbOwner`
* `userAdmin`

## Cluster Administration Roles
* `clusterAdmin`
* `clusterManager`
* `clusterMonitor`
* `hostManager`
]

.column.w48[
## Backup and Restoration Roles
* `backup`
* `restore`

## :warning: All-Database Roles
* `readAnyDatabases`
* `readWriteAnyDatabase`
* `userAdminAnyDatabase`
* `dbAdminAnyDatabase`

## :warning: Superuser Roles
* `root`

## Internal Role
* `__system`: do not use :warning:
]
]

---

# MongoDB - Admin user

:warning: **Disable authorization** in the configuration file first !  

:arrow_right: Create a `root` user with `db.createUser()`.

## .hcenter[\[Shell session\]]
```shell
*$ mongo
> use admin
switched to db admin
> db.createUser({user:"toto", pwd: "toto123", roles: ["root"]})
Successfully added user: { "user" : "toto", "roles" : [ "root" ] }
```

---

# MongoDB - Database user

:arrow_right: Create a user with `readWrite` built-in role.

## .hcenter[\[Shell session\]]
```shell
*$ mongo
> use test_db
switched to db test_db
> db.createUser({user:"user0", pwd: "pwd0", roles: ["readWrite"]})
Successfully added user: { "user" : "user0", "roles" : [ "readWrite" ] }
```

---

# MongoDB - Configuration file with authorization

.row[
.column.w48[
:arrow_right: **Old format**

## .hcenter[\[/etc/mongodb.conf\]]
```ini
# mongodb.conf

# Where to store the data.
dbpath=/home/mongodb

#where to log
logpath=/home/mongodb/mongodb.log

logappend=true

bind_ip = 127.0.0.1
#port = 27017

# Enable journaling, http://www.mongodb.org/display/DOCS/Journaling
journal=false

# Enables periodic logging of CPU utilization and I/O wait
#cpu = true

# Turn on/off security.  Off is currently the default
#noauth = true
*auth = true

[...]
```
]

.column.w48[
:arrow_right: **New format**

## .hcenter[\[/etc/mongodb.conf\]]
```ini
storage:
  dbpath: "/home/mongodb"
  journal:
    enabled: false
systemLog:
  destination: file
  path: "/home/mongodb/mongodb.log"
  logappend: true
net:
  bindIp: 127.0.0.1
  port: 27017
  maxIncomingConnections: 20000
security:
* authorization: enabled
```
]
]

---

# MongoDB - Restart a server

## With `Systemd`

```shell
$ systemctl restart mongodb.service
$ systemctl status mongodb.service
TODO
$ journalctl -u mongodb
TODO (montrer auth active)
```

---

# MongoDB - Login as admin

## Using CLI options

:arrow_right: Syntax: `mongo mongodb://user:passwd@host/db`

## .hcenter[\[Shell session\]]
```shell
*$ mongo mongodb://toto:toto123@127.0.0.1/admin
MongoDB shell version v3.4.7
connecting to: mongodb://toto:toto123@127.0.0.1/admin
MongoDB server version: 3.4.7
> 
```

## Using `mongo` commands

:arrow_right: Command: `db.auth({user: 'user', pwd: 'pwd'})`

## .hcenter[\[Shell session\]]
```shell
*$ mongo mongodb://127.0.0.1
MongoDB shell version v3.4.7
connecting to: mongodb://127.0.0.1
MongoDB server version: 3.4.7
> use admin
switched to db admin
> db.auth({user:'toto', pwd:'WRONGPASSWORD'})
Error: Authentication failed.
0
> db.auth({user:'toto', pwd:'toto123'})
1
>
```

---

# MongoDB - Login as user

## Using CLI options

:arrow_right: Syntax: `mongo mongodb://user:passwd@host/db`

## .hcenter[\[Shell session\]]
```shell
*$ mongo mongodb://user0:pwd0@127.0.0.1/test_db
MongoDB shell version v3.4.7
connecting to: mongodb://toto:toto123@127.0.0.1/admin
MongoDB server version: 3.4.7
> 
```

## Using `mongo` commands

:arrow_right: Command: `db.auth({user: 'user', pwd: 'pwd'})`

## .hcenter[\[Shell session\]]
```shell
*$ mongo mongodb://127.0.0.1
MongoDB shell version v3.4.7
connecting to: mongodb://127.0.0.1
MongoDB server version: 3.4.7
> use test_db
switched to db test_db
> db.auth({user:'user0', pwd:'WRONGPASSWORD'})
Error: Authentication failed.
0
> db.auth({user:'user0', pwd:'pwd0'})
1
>
```

---

# MongoDB - Multiple authentications

:arrow_right: It is possible to authenticate as different users at the same time.

:arrow_right: Display connectionStatus with `db.runcommand({connectionStatus: 1})`.

## .hcenter[\[Shell session\]]
```shell
*$ mongo mongodb://toto:toto123@127.0.0.1/admin
MongoDB shell version v3.4.7
connecting to: mongodb://toto:toto123@127.0.0.1/admin
MongoDB server version: 3.4.7
> use test_db
switched to db test_db
> db.auth({user:'user0', pwd:'pwd0'})
1
> db.runCommand({connectionStatus: 1})
{
        "authInfo" : {
                "authenticatedUsers" : [
                        {
                                "user" : "toto",
                                "db" : "admin"
                        },
                        {
                                "user" : "user0",
                                "db" : "test_db"
                        }
                ],
                "authenticatedUserRoles" : [
                        {
                                "role" : "root",
                                "db" : "admin"
                        },
                        {
                                "role" : "read",
                                "db" : "test_db"
                        }
                ]
        },
        "ok" : 1
}
>
```

TODO mise en page

---

# MongoDB - View user's roles

TODO: view roles (`db.getRoles()`)

---

# MongoDB - View user's privileges

TODO: view privileges (`db.getRole('read', {showPrivileges: true})`)

---

# MongoDB - Change user's password

---

# MongoDB - Logs

---

# MongoDB - `GUI` ?

---

# `PyMongo`

---

# `PyMongo` - Features

---

# `PyMongo` - Hello world

TODO: equivalent in pure mongo language

---

# `PyMongo` - Database

---

# `PyMongo` - Collection

---

# `PyMongo` - Insert data

---

# `PyMongo` - Find data

---

# `PyMongo` - Find data from `_id`

---

# `PyMongo` - Insert multiple data

---

# `PyMongo` - Find multiple data

---

# `PyMongo` - Count

---

# `PyMongo` - Range queries

---

# `PyMongo` - Indexing

---

# `PyMongo` - Numpy arrays

---

# `PyMongo` - `GridFS`




</textarea>

    <script src="core/javascript/remark.js"></script>
    <script src="core/javascript/plotly.js" type="text/javascript"></script>
    <script src="core/javascript/MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML&delayStartupUntil=configured" type="text/javascript"></script>
    <script src="core/javascript/emojify.js" type="text/javascript"></script>
    <script src="core/javascript/mermaid.js" type="text/javascript"></script>
    <script src="core/javascript/term.js" type="text/javascript"></script>
    <script src="core/javascript/jquery-2.1.1.min.js" type="text/javascript"></script>
    <script src="core/javascript/extend-jquery.js" type="text/javascript"></script>
    <script src="core/javascript/cinescript.js" type="text/javascript"></script>
    <script src="core/javascript/gitgraph.js" type="text/javascript"></script>
    <script>

    // === Remark.js initialization ===
    var slideshow = remark.create({
      highlightStyle: 'monokai',
      countIncrementalSlides: false,
      highlightLines: true,
      highlightInlineCode: false
    });

    // === Mermaid.js initialization ===
    mermaid.initialize({
      startOnLoad: false,
      cloneCssStyles: false,
      flowchart:{
        height: 50
      },
      sequenceDiagram:{
        width: 110,
        height: 30
      }
    });

    function initMermaid(s) {
      var diagrams = document.querySelectorAll('.mermaid');
      var i;
      for(i=0;i<diagrams.length;i++){
        if(diagrams[i].offsetWidth>0){
          mermaid.init(undefined, diagrams[i]);
        }
      }
    }

    slideshow.on('afterShowSlide', initMermaid);
    initMermaid(slideshow.getSlides()[slideshow.getCurrentSlideIndex()]);

    // === MathJax.js initialization ===
    MathJax.Hub.Config({ tex2jax: { skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'] } }); 
    MathJax.Hub.Queue(function() { $(MathJax.Hub.getAllJax()).map(function(index, elem) { return(elem.SourceElement()); }).parent().addClass('has-jax'); });
    MathJax.Hub.Configured();

    // === Emojify.js initialization ===
    emojify.run();

    // === Cinescript initialization ===
    $(document).ready(init_cinescripts);

    </script>
  </body>
</html>

